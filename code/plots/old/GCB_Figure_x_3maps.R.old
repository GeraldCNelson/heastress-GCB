
this <- system('hostname', TRUE)
if (this == "LAPTOP-IVSPBGCA") {
	setwd("G:/.shortcut-targets-by-id/1mfeEftF_LgRcxOT98CBIaBbYN4ZHkBr_/share/pwc")
} else {
	setwd('/Users/gcn/Google Drive/My Drive/pwc')
}

library(terra)

path <- "data-raw/ISIMIP/pwc_agg3"
dir.create("figures", F, F)
prj <- "+proj=robin"
wrld <- geodata::world(path="data-raw")


make_3plot <- function(x, crops, capt, main="", pngfile="") {

	subs <- paste0("(", letters[1:3], ")")
	e <- ext(-12000000, 16038790, -6168256, 6942628)

	wrld <- project(wrld, prj) |> crop(e)
	back <- crop(project(crops, prj), e)
	x <- mask(x, crops, maskvalue=FALSE)
	x <- crop(project(x, prj), e)
	
	grat <- graticule(30, crs=prj) |> crop(e)
	cols <- rev(viridis::turbo(100)[15:100])

#	rng <- range(minmax(x))
	rng <- c(35, 100)
	lege <- ext(18000000, 19000000, -9000000, 9000000)

	if (pngfile != "") {
		png(pngfile, units="in", width=5, height=6, res=300)
	}
	layout(matrix(c(1:4,4,4), 3, 2), width=c(1,.2))
	for (i in 1:3) {
<<<<<<< HEAD
		plot(grat, col="gray", background="azure", lty=2, mar=c(0,0,0,0), labels=FALSE)
		plot(back, add=TRUE, axes=FALSE, legend=FALSE, col="light gray")
		plot(x[[i]], add=TRUE, axes=FALSE, col=cols, legend=i==2, plg=list(ext=lege, cex=1.1), xpd=TRUE, range=rng)
		lines(wrld, col=gray(.4), lwd=.5)
		text(-11300000, -5200000, subs[i], font=2, cex=2)
=======
	  print(subs[i])
	  print(capt[i])
	  print(x[[i]])
		plot(grat, col="gray", background="white", lty=2, mar=c(0,0,0,0), labels=FALSE)
		plot(back, add=TRUE, axes=FALSE, legend=FALSE, col="light gray")
		plot(x[[i]], add=TRUE, axes=FALSE, col=cols, legend=i==2, plg=list(ext=lege, cex=1.1), xpd=TRUE, range=rng)
		lines(wrld, col=gray(.4), lwd=.5)
		text(-11300000, -5200000, substitute(paste(bold(subs[i]))), cex=2) # problematic!
>>>>>>> 94371a5 (minor edits)
		text(vect(cbind(-2000000, -5463047)), capt[i], pos=4, halo=TRUE)
	}
	# add legend
	plot(0, axes=FALSE, type="n")
	text(0.6, ifelse(grepl("\n", main), 0.6, 0.52), pos=4, xpd=TRUE, main, cex=1.4)

	if (pngfile != "") dev.off()
}


library(terra)
crps <- rast("data-raw/crops/total_crop_area.tif", win = ext(-180, 180, -60, 67)) |> 
  aggregate(6, sum, na.rm=TRUE) |> round()

# crps <- rast("data-raw/crops/total_crop_area.tif")
# crps <- aggregate(crps, 6, sum, na.rm=TRUE)
# crps <- crop(crps, c(-180, 180, -60, 67))
crps <- mask(crps>100, wrld)

capt <- c("1991-2010", "SSP5-8.5, 2041-2060", "SSP5-8.5, 2081-2100")
avars <- c("annual", "season", "hot90")

for (a in avars) {
	f <- file.path(path, paste0("pwc_", a, "_mean.tif"))
	r <- rast(f)[[c(1,4,5)]]
	mainval <- paste0("PWC\n", a)
	if (a == "hot90")	mainval <- paste0("PWC\n", "summer")
	make_3plot(r, crps, capt, main=mainval, paste0("figures/maps_pwc_", a, ".png"))
}

x = r; crps = crops; main = ""; pngfile=""
#make_3plot <- function(x, crops, capt, main="", pngfile="") {


rann <- rast(file.path(path, paste0("pwc_annual_mean.tif")))[[c(1,4,5)]]
rsea <- rast(file.path(path, paste0("pwc_season_mean.tif")))[[c(1,4,5)]]
rhot <- rast(file.path(path, paste0("pwc_hot90_mean.tif")))[[c(1,4,5)]]
tvars <- c("1991-2010", "2041-2060", "2081-2100")

for (i in 1:3) {
	f <- file.path(path, paste0("pwc_", tvars[i], ".tif"))
	r <- c(rann[[i]], rsea[[i]], rhot[[i]])
	make_3plot(r, crps, capt=avars, main=paste0("PWC\n", a), paste0("figures/maps_pwc_", tvars[i], ".png"))
}

